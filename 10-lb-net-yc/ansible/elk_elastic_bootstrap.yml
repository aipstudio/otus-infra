- hosts: "{{ variable_hosts | default('elasticsearchs') }}"
  remote_user: "{{ remote_user }}"
  become: true
  tasks:
    - name: ELK-elastic-bootstrap | copy elastic config
      vars:
        elk_bootstrap: "yes"
      template:
        src: elasticsearch.yml
        dest: /etc/elasticsearch/elasticsearch.yml
      when: inventory_hostname == groups['elasticsearchs'][0]

    - name: ELK-elastic-bootstrap | start first node service
      systemd:
        name: elasticsearch
        enabled: yes
        state: started
        daemon-reload: yes
      when: inventory_hostname == groups['elasticsearchs'][0]

    - name: ELK-elastic-bootstrap | pause (for startup java)
      pause:
        seconds: 10
      when: inventory_hostname == groups['elasticsearchs'][0]

    - name: ELK-elastic | set user password - 1
      shell: /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -a -b -s
      register: elastic_pass
      when: inventory_hostname == groups['elasticsearchs'][0]

    - name: ELK-elastic | set user password - 2
      shell: |
        curl -k -u elastic:"{{ elastic_pass.stdout }}" -X PUT "https://localhost:9200/_security/user/elastic/_password?pretty" -H "Content-Type: application/json" -d'{ "password" : "{{ elk_pass_elastic }}" }'
      when: inventory_hostname == groups['elasticsearchs'][0]



    - name: ELK-elastic-bootstrap | start other node service
      systemd:
        name: elasticsearch
        enabled: yes
        state: started
        daemon-reload: yes
      when: inventory_hostname != groups['elasticsearchs'][0]

    - name: ELK-elastic-bootstrap | pause (for startup java)
      pause:
        seconds: 10
      when: inventory_hostname != groups['elasticsearchs'][0]



    - name: ELK-elastic-status | get status
      shell: curl -k -u elastic:{{ elk_pass_elastic }} https://127.0.0.1:9200/_cat/nodes
      register: elk_status
      when: inventory_hostname == groups['elasticsearchs'][0]

    - name: ELK-elastic-status | show status
      debug: msg="{{ elk_status.stdout_lines }}"
      when: inventory_hostname == groups['elasticsearchs'][0]
